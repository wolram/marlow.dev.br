name: Create Blog Post from Issue

on:
  issues:
    types: [labeled]

jobs:
  create-post:
    if: github.event.label.name == 'blog-post'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate blog post files
        id: generate
        run: python3 scripts/generate_blog_post.py
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}

      - name: Setup git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch and commit
        id: branch
        env:
          SLUG: ${{ steps.generate.outputs.slug }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          TITLE_EN: ${{ steps.generate.outputs.title_en }}
        run: |
          BRANCH="blog/${SLUG}"
          git checkout -b "$BRANCH"
          git add blog/ pt/blog/ sitemap.xml
          git commit -m "feat: add blog post ${SLUG}

          Auto-generated from issue #${ISSUE_NUM}
          Title: ${TITLE_EN}"
          git push origin "$BRANCH"
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT

      - name: Create Pull Request and comment on issue
        uses: actions/github-script@v7
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          SLUG: ${{ steps.generate.outputs.slug }}
          BRANCH: ${{ steps.branch.outputs.branch }}
        with:
          script: |
            const slug = process.env.SLUG;
            const branch = process.env.BRANCH;
            const issueNum = context.issue.number;
            const issueTitle = process.env.ISSUE_TITLE;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Blog: ${issueTitle}`,
              head: branch,
              base: 'master',
              body: [
                `## Blog Post Gerado Automaticamente`,
                ``,
                `Closes #${issueNum}`,
                ``,
                `### Arquivos gerados`,
                `- \`blog/${slug}.html\` (EN)`,
                `- \`pt/blog/${slug}.html\` (PT)`,
                `- \`sitemap.xml\` (atualizado)`,
                ``,
                `_Gerado automaticamente por GitHub Actions_`,
              ].join('\n'),
            });

            await github.rest.issues.createComment({
              issue_number: issueNum,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: [
                `✅ **PR criado:** #${pr.data.number}`,
                ``,
                `Após o merge, o post será publicado em:`,
                `- EN: https://marlow.dev.br/blog/${slug}.html`,
                `- PT: https://marlow.dev.br/pt/blog/${slug}.html`,
              ].join('\n'),
            });
